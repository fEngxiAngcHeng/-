!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){"use strict";function Mosaicflow(container,options){this.container=container,this.options=options,this.container.trigger("start"),this.init(),this.container.trigger("ready")}function dataToOptions(elem){function upper(m,l){return l.toUpper()}var options={},data=elem.data();for(var key in data)options[key.replace(/-(\w)/g,upper)]=data[key];return options}function getImageSizes(image){var sizes={};if(sizes.height=parseInt(image.attr("height"),10),sizes.width=parseInt(image.attr("width"),10),0===sizes.height||0===sizes.width){var utilImage=new Image;utilImage.src=image.attr("src"),sizes.width=utilImage.width,sizes.height=utilImage.height}return sizes}var cnt=0;$.fn.mosaicflow=function(options){var args=Array.prototype.slice.call(arguments,0);return this.each(function(){var elm=$(this),data=elm.data("mosaicflow");data?"string"==typeof options&&data[options](args[1]):(options=$.extend({},$.fn.mosaicflow.defaults,options,dataToOptions(elm)),data=new Mosaicflow(elm,options),elm.data("mosaicflow",data))})},$.fn.mosaicflow.defaults={itemSelector:"> *",columnClass:"mosaicflow__column",minItemWidth:240,itemHeightCalculation:"auto"},Mosaicflow.prototype={init:function(){this.__uid=cnt++,this.__uidItemCounter=0,this.items=this.container.find(this.options.itemSelector),this.columns=$([]),this.columnsHeights=[],this.itemsHeights={},this.tempContainer=$("<div>").css({visibility:"hidden",width:"100%"}),this.workOnTemp=!1,this.autoCalculation="auto"===this.options.itemHeightCalculation,this.container.append(this.tempContainer);var that=this;this.items.each(function(){var elm=$(this),id=elm.attr("id");id||(id=that.generateUniqueId(),elm.attr("id",id))}),this.container.css("visibility","hidden"),this.autoCalculation?$(window).load($.proxy(this.refill,this)):this.refill(),$(window).resize($.proxy(this.refill,this))},refill:function(){this.container.trigger("fill"),this.numberOfColumns=Math.floor(this.container.width()/this.options.minItemWidth),this.numberOfColumns<1&&(this.numberOfColumns=1);var needToRefill=this.ensureColumns();needToRefill&&(this.fillColumns(),this.columns.filter(":hidden").remove()),this.container.css("visibility","visible"),this.container.trigger("filled")},ensureColumns:function(){var createdCnt=this.columns.length,calculatedCnt=this.numberOfColumns;if(this.workingContainer=0===createdCnt?this.tempContainer:this.container,calculatedCnt>createdCnt)for(var neededCnt=calculatedCnt-createdCnt,columnIdx=0;neededCnt>columnIdx;columnIdx++){var column=$("<div>",{"class":this.options.columnClass});this.workingContainer.append(column)}else if(createdCnt>calculatedCnt){for(var lastColumn=createdCnt;lastColumn>=calculatedCnt;)this.columns.eq(lastColumn).hide(),lastColumn--;var diff=createdCnt-calculatedCnt;this.columnsHeights.splice(this.columnsHeights.length-diff,diff)}return calculatedCnt!==createdCnt?(this.columns=this.workingContainer.find("."+this.options.columnClass),this.columns.css("width",100/calculatedCnt+"%"),!0):!1},fillColumns:function(){for(var columnsCnt=this.numberOfColumns,itemsCnt=this.items.length,columnIdx=0;columnsCnt>columnIdx;columnIdx++){var column=this.columns.eq(columnIdx);this.columnsHeights[columnIdx]=0;for(var itemIdx=columnIdx;itemsCnt>itemIdx;itemIdx+=columnsCnt){var item=this.items.eq(itemIdx),height=0;column.append(item),height=this.autoCalculation?item.outerHeight():parseInt(item.find("img").attr("height"),10),this.itemsHeights[item.attr("id")]=height,this.columnsHeights[columnIdx]+=height}}this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.workingContainer===this.tempContainer&&this.container.append(this.tempContainer.children()),this.container.trigger("mosaicflow-layout")},levelBottomEdge:function(itemsHeights,columnsHeights){for(;;){var lowestColumn=$.inArray(Math.min.apply(null,columnsHeights),columnsHeights),highestColumn=$.inArray(Math.max.apply(null,columnsHeights),columnsHeights);if(lowestColumn===highestColumn)return;var lastInHighestColumn=this.columns.eq(highestColumn).children().last(),lastInHighestColumnHeight=itemsHeights[lastInHighestColumn.attr("id")],lowestHeight=columnsHeights[lowestColumn],highestHeight=columnsHeights[highestColumn],newLowestHeight=lowestHeight+lastInHighestColumnHeight;if(newLowestHeight>=highestHeight)return;this.columns.eq(lowestColumn).append(lastInHighestColumn),columnsHeights[highestColumn]-=lastInHighestColumnHeight,columnsHeights[lowestColumn]+=lastInHighestColumnHeight}},add:function(elm){this.container.trigger("add");var lowestColumn=$.inArray(Math.min.apply(null,this.columnsHeights),this.columnsHeights),height=0;if(this.autoCalculation){elm.css({position:"static",visibility:"hidden",display:"block"}).appendTo(this.columns.eq(lowestColumn)),height=elm.outerHeight();var inlineImages=elm.find("img");0!==inlineImages.length&&inlineImages.each(function(){var image=$(this),imageSizes=getImageSizes(image),actualHeight=image.width()*imageSizes.height/imageSizes.width;height+=actualHeight}),elm.detach().css({position:"static",visibility:"visible"})}else height=parseInt(elm.find("img").attr("height"),10);elm.attr("id")||elm.attr("id",this.generateUniqueId());var itemsArr=this.items.toArray();itemsArr.push(elm),this.items=$(itemsArr),this.itemsHeights[elm.attr("id")]=height,this.columnsHeights[lowestColumn]+=height,this.columns.eq(lowestColumn).append(elm),this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.container.trigger("mosaicflow-layout"),this.container.trigger("added")},remove:function(elm){this.container.trigger("remove");var column=elm.parents("."+this.options.columnClass);this.columnsHeights[column.index()-1]-=this.itemsHeights[elm.attr("id")],elm.detach(),this.items=this.items.not(elm),this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.container.trigger("mosaicflow-layout"),this.container.trigger("removed")},empty:function(){var columnsCnt=this.numberOfColumns;this.items=$([]),this.itemsHeights={};for(var columnIdx=0;columnsCnt>columnIdx;columnIdx++){var column=this.columns.eq(columnIdx);this.columnsHeights[columnIdx]=0,column.empty()}this.container.trigger("mosaicflow-layout")},recomputeHeights:function(){function computeHeight(idx,item){item=$(item);var height=0;height=that.autoCalculation?item.outerHeight():parseInt(item.find("img").attr("height"),10),that.itemsHeights[item.attr("id")]=height,that.columnsHeights[columnIdx]+=height}for(var that=this,columnsCnt=this.numberOfColumns,columnIdx=0;columnsCnt>columnIdx;columnIdx++){var column=this.columns.eq(columnIdx);this.columnsHeights[columnIdx]=0,column.children().each(computeHeight)}},generateUniqueId:function(){return this.__uidItemCounter++,"mosaic-"+this.__uid+"-itemid-"+this.__uidItemCounter}},$(function(){$(".mosaicflow").mosaicflow()})});